### Goals

- separate supabase accounts
- deployment to production system
- test suite

### 1. Setup

Set up prod supabase account

Setup aws s3

Create prod branch in github, as main is taken by lovable

### 2. Code changes

Create migration scripts in `/supabase/migrations/`

â†’ You can get initial schema.sql from the dev version via psql (or interface)

Update `src/integrations/supabase/client.ts`

â†’ allow client to use supabase_url and anon_key from .env file

Remark: Supabase url and anon key is always in frontend, but safe if you use RLS for authenticated users

```jsx

// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

// Get environment variables with fallbacks to the current hardcoded values
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || "https://xxx.supabase.co";
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY || "xxx";

export const supabase = createClient<Database>(supabaseUrl, supabaseKey);
```

### 3. Local supabase tests

Run a local supabase instance and create `.env file`

Start a local supabase instance with `supabase init` and `supabase start`

```jsx
VITE_SUPABASE_URL=https://your-project-url.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

```

### 4. Deploy via Github action

Build frontend project and copy to S3

Run Database Migrations

Deploy edge functions

Invalidate Cloudfront Cache

```jsx
name: Deploy Application and Edge Functions

on:
  push:
    branches:
      - prod

jobs:
  deploy-app:
    name: Deploy Frontend Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "# Supabase Configuration" > .env
          echo "VITE_SUPABASE_URL=${{ secrets.SUPABASE_PROD_URL }}" >> .env
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_PROD_ANON_KEY }}" >> .env

      - name: Replace project_id in config.toml
        run: |
          project_id="${{ secrets.SUPABASE_PROD_PROJECT_ID }}"
          sed -i "s|project_id = \".*\"|project_id = \"${project_id}\"|" supabase/config.toml

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Deploy to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          S3_BUCKET: 'app.clinero.de'
        run: |
          aws s3 sync ./dist s3://$S3_BUCKET --delete
          aws s3 cp ./dist/index.html s3://$S3_BUCKET/index.html --cache-control "no-cache"

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Run Supabase Migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_PROD_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_PROD_DB_PASSWORD }}
          PROJECT_ID: ${{ secrets.SUPABASE_PROD_PROJECT_ID }}
        run: |
          supabase --version
         
          supabase link --project-ref $PROJECT_ID
          supabase db push

  deploy-edge-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    needs: [deploy-app]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_PROD_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_PROD_DB_PASSWORD }}
          PROJECT_ID: ${{ secrets.SUPABASE_PROD_PROJECT_ID }}
        run: |
          supabase functions deploy --project-ref $PROJECT_ID

  invalidate-cache:
    name: Invalidate CloudFront Cache
    needs: [deploy-app, deploy-edge-functions]
    if: ${{ always() && !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: Invalidate CloudFront Cache
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          DISTRIBUTION_ID: 'EBLN0BBEJAONV'
        run: |
          aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"

```

To be improved: Deploy supabase functions only on code change in `/supabase/functions`

ðŸ”´Â Before each pull request to prod, make sure to create migrations file in your repo

- either by hand in cursor
- tell lovable to create a migrations
- or via supabase command: `supabase migration new <add_column_to_table_xxx>`

### 5. Run Playwright tests

Checkout code, create a supabase instance, create database and insert first user, run tests

```jsx

name: Playwright Tests

on:
  pull_request:
    branches:
      - prod

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
        
      - name: Start Supabase project
        run: |
          # Initialize the Supabase project (if not already initialized)
          supabase init --force --with-intellij-settings --with-vscode-settings 

          # Start the Supabase services (Postgres, Auth, Storage)
          supabase start

      - name: Set up database schema
        run: |
          export SUPABASE_URL=postgresql://postgres:postgres@127.0.0.1:54322/postgres

          # Drop schema and reset the database (assuming schema.sql exists in 'data/schema.sql')
          # psql $SUPABASE_URL -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
          # psql $SUPABASE_URL -f data/schema.sql

          # Run migrations (if applicable)
          #supabase migrations up

          # insert first user
          psql $SUPABASE_URL -f tests/data/auth.users.sql 
          psql $SUPABASE_URL -f tests/data/auth.identities.sql 
          psql $SUPABASE_URL -f tests/data/profiles.sql 

      - name: Create .env file
        run: |
          echo "# Supabase Configuration" > .env
          echo "VITE_SUPABASE_URL=http://127.0.0.1:54321" >> .env
          echo "VITE_SUPABASE_ANON_KEY=$(supabase status 2>/dev/null | grep 'anon key' | awk '{print $3}')" >> .env

      - name: Install Playwright
        run: npm install @playwright/test  
      - name: Install Playwright Browsers
        run: npx playwright install chromium --with-deps
        
      - name: Run Playwright tests
        run: npx playwright test
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

```

Add playwright.config.ts â†’ local server in github runner is started when playwright test run
